name: Deploy to VPS

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          
      - name: Add SSH host
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
          
      - name: Deploy to VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} '
            set -euo pipefail
            cd dasha &&
            git pull origin main &&
            docker compose down --remove-orphans &&
            docker compose build --no-cache &&
            if ss -Hln sport = :80 | grep -q :80; then
              echo "Port 80 busy; stop the listed service before deploying." >&2
              ss -ltnp sport = :80
              exit 1
            fi &&
            if ss -Hln sport = :443 | grep -q :443; then
              echo "Port 443 busy; stop the listed service before deploying." >&2
              ss -ltnp sport = :443
              exit 1
            fi &&
            docker compose up -d
          ' 